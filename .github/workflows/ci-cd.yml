name: CI/CD Pipeline

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  # Step 1: Generate SBOM
  sbom:
    uses: ./.github/workflows/sbom.yml
    permissions:
      contents: read

  # Step 2: Secret Scanning
  secret-scan:
    uses: ./.github/workflows/secret-scan.yml
    permissions:
      contents: read

  # Step 3: SAST with CodeQL
  codeql:
    uses: ./.github/workflows/codeql.yml
    permissions:
      security-events: write
      actions: read
      contents: read

  # Step 4: SCA - Dependency Scanning
  sca:
    uses: ./.github/workflows/sca.yml
    permissions:
      contents: read
      security-events: write

  # Step 5: Build Application
  build:
    uses: ./.github/workflows/build.yml
    permissions:
      contents: read

  # Step 6: Build and Scan Container Image
  container-build:
    needs: [build]
    uses: ./.github/workflows/container-build.yml
    permissions:
      contents: read
      packages: write
      security-events: write

  # Step 7: Sign Container Image
  sign-image:
    needs: [container-build]
    uses: ./.github/workflows/sign-image.yml
    permissions:
      contents: read
      packages: write
      id-token: write
    with:
      image-digest: ${{ needs.container-build.outputs.image-digest }}

  # Step 8: Quality Gate
  quality-gate:
    needs: [secret-scan, sca, container-build, sign-image]
    uses: ./.github/workflows/quality-gate.yml
    with:
      signature-verified: ${{ needs.sign-image.outputs.signature-verified }}

  # Step 9: Deploy to Kubernetes
  deploy:
    needs: [quality-gate, sign-image, container-build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    uses: ./.github/workflows/deploy.yml
    permissions:
      contents: read
      issues: write
      pull-requests: write
    with:
      image-digest: ${{ needs.container-build.outputs.image-digest }}
