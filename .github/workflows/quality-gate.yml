name: Quality Gate

on:
  workflow_call:
    inputs:
      signature-verified:
        description: "Whether the image signature was verified"
        required: true
        type: string

jobs:
  quality-gate:
    name: Quality Gate
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Download audit results
        uses: actions/download-artifact@v5
        with:
          name: audit-results

      - name: Download container scan results
        uses: actions/download-artifact@v5
        with:
          name: container-scan-results

      - name: Evaluate Quality Gate
        id: quality-gate
        run: |
          echo "=== Quality Gate Evaluation ==="
          
          # Check 1: Secrets (already failed if secrets found in secret-scan job)
          echo "âœ… Check 1: No secrets found (passed secret-scan job)"
          
          # Check 2: Check CVSS >= 7.0 vulnerabilities
          echo "ðŸ“Š Check 2: Checking for CVSS >= 7.0 vulnerabilities..."
          
          # Check npm audit results
          if [ -f audit-check.json ]; then
            HIGH_VULNS=$(jq '.metadata.vulnerabilities.high // 0' audit-check.json)
            CRITICAL_VULNS=$(jq '.metadata.vulnerabilities.critical // 0' audit-check.json)
            echo "  - NPM High vulnerabilities: $HIGH_VULNS"
            echo "  - NPM Critical vulnerabilities: $CRITICAL_VULNS"
            
            if [ "$CRITICAL_VULNS" -gt 0 ] || [ "$HIGH_VULNS" -gt 0 ]; then
              echo "âŒ FAILED: Found vulnerabilities with CVSS >= 7.0 in dependencies"
              exit 1
            fi
          fi
          
          # Check container scan results
          if [ -f trivy-report.json ]; then
            CONTAINER_HIGH=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "HIGH")] | length' trivy-report.json)
            CONTAINER_CRITICAL=$(jq '[.Results[]?.Vulnerabilities[]? | select(.Severity == "CRITICAL")] | length' trivy-report.json)
            echo "  - Container High vulnerabilities: $CONTAINER_HIGH"
            echo "  - Container Critical vulnerabilities: $CONTAINER_CRITICAL"
            
            if [ "$CONTAINER_CRITICAL" -gt 0 ] || [ "$CONTAINER_HIGH" -gt 0 ]; then
              echo "âŒ FAILED: Found vulnerabilities with CVSS >= 7.0 in container image"
              exit 1
            fi
          fi
          
          echo "âœ… Check 2: No high/critical vulnerabilities found"
          
          # Check 3: Signature verification
          echo "ðŸ“ Check 3: Verifying image signature..."
          if [ "${{ inputs.signature-verified }}" != "true" ]; then
            echo "âŒ FAILED: Image signature verification failed"
            exit 1
          fi
          echo "âœ… Check 3: Image signature verified"
          
          echo ""
          echo "ðŸŽ‰ All quality gate checks passed!"

          echo "âœ… All quality gate checks passed!" >> $GITHUB_STEP_SUMMARY
